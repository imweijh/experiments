<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript">
    var map;
    document.addEventListener("deviceready", function() {
      var div = document.getElementById("map_canvas");

      // Initialize the map view
      map = plugin.google.maps.Map.getMap(div);

      // Wait until the map is ready status.
      map.addEventListener(plugin.google.maps.event.MAP_READY, onMapReady);
    }, false);

    var beacon;
    window.onerror = function(m, u, l) {
      alert(l + ": " + m);
    };

    function onMapReady() {
      var button = document.getElementById("button");
      button.addEventListener("click", onBtnClicked, false);
      document.getElementById("gas").addEventListener("click", findGas, false);

      var watchId = navigator.geolocation.watchPosition(function(position) {

        // Set camera target to be near the bottom of the map if we tilt/bearing are being used.
        var lat = position.coords.latitude + Math.cos((position.coords.heading) * (Math.PI / 180)) * (0.005);
        var lng = position.coords.longitude + Math.sin((position.coords.heading) * (Math.PI / 180)) * (0.005);
        // TODO(sissel): Find out what multipliers we need for each zoom level. 0.005 works well at zoom 15 only.

        var msg = [
          "latitude:" + position.coords.latitude,
          "longitude:" + position.coords.longitude,
          "speed:" + position.coords.speed,
          "time:" + position.timestamp,
          "bearing:" + position.coords.heading,
          "beacon:" + beacon,
          "camlat:" + lat,
          "camlng:" + lng,
          "camlat2:" + Math.cos((position.coords.heading - 180) * (180 / Math.PI)),
        ].join("\n");

        document.getElementById("t").innerHTML = msg;

        map.animateCamera({
          //target: { lat: position.coords.latitude, lng: position.coords.longitude },
          target: { lat: lat, lng: lng },
          zoom: 14,
          tilt: 70,
          duration: 1250,
          bearing: position.coords.heading,
        });
        if (beacon === undefined) {
          map.addCircle({
            center: { lat: position.coords.latitude, lng: position.coords.longitude },
            radius: 16,
            fillColor: "#AAAACC88",
            strokeColor: "#00000088",
            strokeWidth: 1,
          }, function(circle) { beacon = circle });
        } else {
          beacon.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
        }
      });
    }

    function onBtnClicked() {
      map.showDialog();
    }

    function findGas() {
      var x = document.createElement("div");
      var search = new google.maps.places.PlacesService(x);
      search.nearbySearch({
        location: beacon.getCenter(),
        types: [ "gas_station" ],
        rankBy: google.maps.places.RankBy.DISTANCE,
        //openNow: true
      }, function(results) {
        var text = "";
        for (i in results) {
          var l = results[i].geometry.location;
          map.addMarker({
            position: { lat: l.lat(), lng: l.lng() },
            title: results[i].name
          }, function(m) {
            m.showInfoWindow()
          })
          text = text + i + ": " + l.lat() + ":::" + l.lng() + " / " + results[i].name + "\n";
        }
        document.getElementById("t").innerHTML = text;
      });
    }
    </script>
  </head>
  <body style="height: 100%;">
    <div style="width:100%;height:400px" id="map_canvas"></div>
    <button id="button">Full Screen</button>
    <button id="gas">Find Gas</button>

    <pre id="t" style="width: 100%;"></pre>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYjDJNXBo_9VH7gM8YAtM8vXVwiNegokY&libraries=places"></script>
  </body>
</html>
